---
- name: Deploy ownCloud OCIS and Keycloak to AKS
  hosts: "{{ target_env }}"
  gather_facts: false
  
  vars:
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') }}"
    
  tasks:
    - name: Install required Python packages
      pip:
        name:
          - kubernetes
          - openshift
          - PyYAML
        state: present
      delegate_to: localhost

    - name: Install NGINX Ingress Controller
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          controller:
            service:
              annotations:
                service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz

    - name: Install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          installCRDs: true

    - name: Wait for cert-manager to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: cert-manager
        label_selectors:
          - app.kubernetes.io/name=cert-manager
        kubeconfig: "{{ kubeconfig_path }}"
      register: cert_manager_pods
      until: cert_manager_pods.resources | length > 0 and cert_manager_pods.resources[0].status.phase == "Running"
      retries: 10
      delay: 30

    - name: Install Azure Key Vault CSI Driver
      kubernetes.core.helm:
        name: csi-secrets-store-provider-azure
        chart_ref: csi-secrets-store-provider-azure/csi-secrets-store-provider-azure
        release_namespace: kube-system
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          secrets-store-csi-driver:
            syncSecret:
              enabled: true

    - name: Install Prometheus Stack (Production only)
      when: target_env == 'prod'
      block:
        - name: Add Prometheus Community Helm repo
          kubernetes.core.helm_repository:
            name: prometheus-community
            repo_url: https://prometheus-community.github.io/helm-charts

        - name: Update Helm repositories
          command: helm repo update
          delegate_to: localhost

        - name: Read Prometheus values file
          set_fact:
            prometheus_values_content: "{{ lookup('file', playbook_dir + '/../k8s/overlays/prod/prometheus-values.yaml') }}"

        - name: Replace domain placeholder in Prometheus values
          copy:
            content: "{{ prometheus_values_content | replace('DOMAIN_PLACEHOLDER', ocis_hostname) }}"
            dest: /tmp/prometheus-values-{{ target_env }}.yaml
          delegate_to: localhost

        - name: Install kube-prometheus-stack
          kubernetes.core.helm:
            name: prometheus
            chart_ref: prometheus-community/kube-prometheus-stack
            release_namespace: monitoring
            create_namespace: true
            kubeconfig: "{{ kubeconfig_path }}"
            values_files:
              - /tmp/prometheus-values-{{ target_env }}.yaml
            wait: true
            wait_timeout: 15m

        - name: Display Prometheus deployment info
          debug:
            msg:
              - "âœ… Prometheus stack deployed successfully"
              - "Grafana will be available at https://grafana.{{ ocis_hostname }}"
              - "Default Grafana credentials: admin / ChangeThisPassword123!"

    - name: Apply Kubernetes manifests with Kustomize
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/overlays/{{ target_env }}"
        kubeconfig: "{{ kubeconfig_path }}"
        apply: true

    - name: Wait for PostgreSQL to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: owncloud
        label_selectors:
          - app=postgres
        kubeconfig: "{{ kubeconfig_path }}"
      register: postgres_pods
      until: postgres_pods.resources | length > 0 and postgres_pods.resources[0].status.phase == "Running"
      retries: 10
      delay: 30

    - name: Wait for Keycloak to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: owncloud
        label_selectors:
          - app=keycloak
        kubeconfig: "{{ kubeconfig_path }}"
      register: keycloak_pods
      until: keycloak_pods.resources | length > 0 and keycloak_pods.resources[0].status.phase == "Running"
      retries: 15
      delay: 30

    - name: Wait for OCIS to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: owncloud
        label_selectors:
          - app=ocis
        kubeconfig: "{{ kubeconfig_path }}"
      register: ocis_pods
      until: ocis_pods.resources | length > 0 and ocis_pods.resources[0].status.phase == "Running"
      retries: 15
      delay: 30

    - name: Get Ingress external IP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: ingress-nginx-controller
        namespace: ingress-nginx
        kubeconfig: "{{ kubeconfig_path }}"
      register: ingress_service
      until: ingress_service.resources[0].status.loadBalancer.ingress is defined
      retries: 10
      delay: 30

    - name: Display deployment information
      debug:
        msg:
          - "Deployment completed successfully!"
          - "Ingress IP: {{ ingress_service.resources[0].status.loadBalancer.ingress[0].ip }}"
          - "Please configure your DNS to point to this IP address"
          - "Keycloak URL: https://{{ keycloak_hostname }}"
          - "OCIS URL: https://{{ ocis_hostname }}"
          - "{% if target_env == 'prod' %}Grafana URL: https://grafana.{{ ocis_hostname }}{% endif %}"
          - "{% if target_env == 'prod' %}Grafana default password: 5T3phane (change immediately!){% endif %}"
