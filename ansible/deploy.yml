---
- name: Deploy ownCloud OCIS and Keycloak to AKS
  hosts: "{{ target_env }}"
  gather_facts: false
  
  vars:
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') }}"
    
  tasks:
    - name: Install required Python packages
      pip:
        name:
          - kubernetes
          - openshift
          - PyYAML
        state: present
      delegate_to: localhost

    - name: Install NGINX Ingress Controller
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          controller:
            service:
              annotations:
                service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz

    - name: Install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          installCRDs: true

    - name: Wait for cert-manager to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: cert-manager
        label_selectors:
          - app.kubernetes.io/name=cert-manager
        kubeconfig: "{{ kubeconfig_path }}"
      register: cert_manager_pods
      until: cert_manager_pods.resources | length > 0 and cert_manager_pods.resources[0].status.phase == "Running"
      retries: 10
      delay: 30

    - name: Install Azure Key Vault CSI Driver
      kubernetes.core.helm:
        name: csi-secrets-store-provider-azure
        chart_ref: csi-secrets-store-provider-azure/csi-secrets-store-provider-azure
        release_namespace: kube-system
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          secrets-store-csi-driver:
            syncSecret:
              enabled: true

    - name: Apply Kubernetes manifests with Kustomize
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/overlays/{{ target_env }}"
        kubeconfig: "{{ kubeconfig_path }}"
        apply: true

    - name: Wait for PostgreSQL to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: owncloud
        label_selectors:
          - app=postgres
        kubeconfig: "{{ kubeconfig_path }}"
      register: postgres_pods
      until: postgres_pods.resources | length > 0 and postgres_pods.resources[0].status.phase == "Running"
      retries: 10
      delay: 30

    - name: Wait for Keycloak to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: owncloud
        label_selectors:
          - app=keycloak
        kubeconfig: "{{ kubeconfig_path }}"
      register: keycloak_pods
      until: keycloak_pods.resources | length > 0 and keycloak_pods.resources[0].status.phase == "Running"
      retries: 15
      delay: 30

    - name: Wait for OCIS to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: owncloud
        label_selectors:
          - app=ocis
        kubeconfig: "{{ kubeconfig_path }}"
      register: ocis_pods
      until: ocis_pods.resources | length > 0 and ocis_pods.resources[0].status.phase == "Running"
      retries: 15
      delay: 30

    - name: Get Ingress external IP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: ingress-nginx-controller
        namespace: ingress-nginx
        kubeconfig: "{{ kubeconfig_path }}"
      register: ingress_service
      until: ingress_service.resources[0].status.loadBalancer.ingress is defined
      retries: 10
      delay: 30

    - name: Display deployment information
      debug:
        msg:
          - "Deployment completed successfully!"
          - "Ingress IP: {{ ingress_service.resources[0].status.loadBalancer.ingress[0].ip }}"
          - "Please configure your DNS to point to this IP address"
          - "Keycloak URL: https://{{ keycloak_hostname }}"
          - "OCIS URL: https://{{ ocis_hostname }}"
