---
- name: Deploy ownCloud OCIS and Keycloak to AKS
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') }}"
  vars_files:
    - "{{ playbook_dir }}/inventories/{{ target_env }}.yml"
    
  tasks:
    - name: Install required Python packages
      pip:
        name:
          - kubernetes
          - openshift
          - PyYAML
        state: present
      delegate_to: localhost

    - name: Add Helm repositories
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
        state: present
      loop:
        - name: ingress-nginx
          url: https://kubernetes.github.io/ingress-nginx
        - name: jetstack
          url: https://charts.jetstack.io
        - name: csi-secrets-store-provider-azure
          url: https://azure.github.io/secrets-store-csi-driver-provider-azure/charts
      delegate_to: localhost

    - name: Install NGINX Ingress Controller
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          controller:
            service:
              annotations:
                service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz

    - name: Install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          installCRDs: true

    - name: Wait for cert-manager to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: cert-manager
        label_selectors:
          - app.kubernetes.io/name=cert-manager
        kubeconfig: "{{ kubeconfig_path }}"
      register: cert_manager_pods
      until: cert_manager_pods.resources | length > 0 and cert_manager_pods.resources[0].status.phase == "Running"
      retries: 10
      delay: 30

    - name: Check if CSI Driver already exists
      kubernetes.core.k8s_info:
        api_version: storage.k8s.io/v1
        kind: CSIDriver
        name: secrets-store.csi.k8s.io
        kubeconfig: "{{ kubeconfig_path }}"
      register: csi_driver_check
      ignore_errors: true

    - name: Install Azure Key Vault CSI Driver
      kubernetes.core.helm:
        name: csi-secrets-store-provider-azure
        chart_ref: csi-secrets-store-provider-azure/csi-secrets-store-provider-azure
        release_namespace: kube-system
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          secrets-store-csi-driver:
            syncSecret:
              enabled: true
      when: csi_driver_check.resources | length == 0

    - name: Clean up old Ingress resources
      kubernetes.core.k8s:
        state: absent
        api_version: networking.k8s.io/v1
        kind: Ingress
        name: "{{ item }}"
        namespace: owncloud
        kubeconfig: "{{ kubeconfig_path }}"
      loop:
        - keycloak-ingress
        - ocis-ingress
      ignore_errors: true

    - name: Get AKS kubelet identity client ID
      ansible.builtin.command:
        cmd: az aks show --name {{ cluster_name }} --resource-group {{ resource_group }} --query identityProfile.kubeletidentity.clientId -o tsv
      register: kubelet_client_id
      changed_when: false

    - name: Get tenant ID
      ansible.builtin.command:
        cmd: az account show --query tenantId -o tsv
      register: tenant_id
      changed_when: false

    - name: Create temporary Kustomize directory
      ansible.builtin.tempfile:
        state: directory
      register: temp_kustomize_dir

    - name: Copy Kustomize overlay to temp directory
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../k8s/overlays/{{ target_env }}/"
        dest: "{{ temp_kustomize_dir.path }}/"
        remote_src: false

    - name: Replace KUBELET_CLIENT_ID placeholder in kustomization
      ansible.builtin.replace:
        path: "{{ temp_kustomize_dir.path }}/kustomization.yaml"
        regexp: 'KUBELET_CLIENT_ID'
        replace: "{{ kubelet_client_id.stdout }}"

    - name: Apply Kubernetes manifests with Kustomize
      ansible.builtin.command:
        cmd: kubectl apply -k {{ temp_kustomize_dir.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_kustomize_dir.path }}"
        state: absent

    # - name: Wait for Keycloak to be ready
    #   kubernetes.core.k8s_info:
    #     api_version: v1
    #     kind: Pod
    #     namespace: owncloud
    #     label_selectors:
    #       - app=keycloak
    #     kubeconfig: "{{ kubeconfig_path }}"
    #   register: keycloak_pods
    #   until: keycloak_pods.resources | length > 0 and keycloak_pods.resources[0].status.phase == "Running"
    #   retries: 15
    #   delay: 30

    # - name: Wait for OCIS to be ready
    #   kubernetes.core.k8s_info:
    #     api_version: v1
    #     kind: Pod
    #     namespace: owncloud
    #     label_selectors:
    #       - app=ocis
    #     kubeconfig: "{{ kubeconfig_path }}"
    #   register: ocis_pods
    #   until: ocis_pods.resources | length > 0 and ocis_pods.resources[0].status.phase == "Running"
    #   retries: 15
    #   delay: 30

    - name: Get Ingress external IP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: ingress-nginx-controller
        namespace: ingress-nginx
        kubeconfig: "{{ kubeconfig_path }}"
      register: ingress_service
      until: ingress_service.resources[0].status.loadBalancer.ingress is defined
      retries: 10
      delay: 30

    - name: Display deployment information
      debug:
        msg:
          - "Deployment completed successfully!"
          - "Ingress IP: {{ ingress_service.resources[0].status.loadBalancer.ingress[0].ip }}"
          - "Please configure your DNS to point to this IP address"
          - "Keycloak URL: https://{{ ocis_hostname }}/auth"
          - "OCIS URL: https://{{ ocis_hostname }}"
