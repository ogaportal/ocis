name: Manage SSL Certificates

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to manage certificates for'
        required: true
        type: choice
        options:
          - dev
          - prod
      certificate_type:
        description: 'Type of certificates to create'
        required: true
        type: choice
        options:
          - self-signed
          - trusted
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - renew
          - delete

env:
  DEV_DOMAIN: dev.lesaiglesbraves.online
  PROD_DOMAIN: prod.lesaiglesbraves.online
  DEV_KEYVAULT: owncloudkvdev
  PROD_KEYVAULT: owncloudkvprod

jobs:
  manage-certificates:
    name: Manage Certificates
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set environment variables
        id: set_env
        run: |
          if [ "${{ inputs.environment }}" == "dev" ]; then
            echo "DOMAIN=${{ env.DEV_DOMAIN }}" >> $GITHUB_OUTPUT
            echo "KEYVAULT=${{ env.DEV_KEYVAULT }}" >> $GITHUB_OUTPUT
          else
            echo "DOMAIN=${{ env.PROD_DOMAIN }}" >> $GITHUB_OUTPUT
            echo "KEYVAULT=${{ env.PROD_KEYVAULT }}" >> $GITHUB_OUTPUT
          fi

      - name: Install OpenSSL
        if: inputs.certificate_type == 'self-signed'
        run: sudo apt-get update && sudo apt-get install -y openssl

      - name: Generate self-signed certificates
        if: inputs.certificate_type == 'self-signed' && inputs.action == 'create'
        run: |
          # Create directory for certificates
          mkdir -p certs
          
          # Generate OCIS certificate
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout certs/ocis-tls-key.pem \
            -out certs/ocis-tls-cert.pem \
            -subj "/C=FR/ST=France/L=Paris/O=OwnCloud/OU=IT/CN=${{ steps.set_env.outputs.DOMAIN }}" \
            -addext "subjectAltName=DNS:${{ steps.set_env.outputs.DOMAIN }},DNS:*.${{ steps.set_env.outputs.DOMAIN }}"
          
          echo "‚úÖ Self-signed certificate generated successfully"

      - name: Request trusted CA certificates
        if: inputs.certificate_type == 'trusted' && inputs.action == 'create'
        run: |
          echo "‚ö†Ô∏è Trusted certificates (Let's Encrypt, ZeroSSL, etc.) require manual generation"
          echo ""
          echo "For production environments, follow these steps:"
          echo "1. Use acme.sh or certbot locally to generate certificates with DNS validation"
          echo "2. Upload the generated certificates using upload-certificate.ps1 script"
          echo ""
          echo "Example with acme.sh:"
          echo "  ~/.acme.sh/acme.sh --issue --dns -d ${{ steps.set_env.outputs.DOMAIN }}"
          echo "  # Add the TXT record to your DNS"
          echo "  ~/.acme.sh/acme.sh --renew --dns -d ${{ steps.set_env.outputs.DOMAIN }}"
          echo ""
          echo "Then upload to Key Vault:"
          echo "  .\scripts\upload-certificate.ps1 -CertPath <path> -KeyVaultName ${{ steps.set_env.outputs.KEYVAULT }}"
          echo ""
          echo "Or use Azure CLI directly:"
          echo "  az keyvault certificate import --vault-name ${{ steps.set_env.outputs.KEYVAULT }} --name ocis-tls-cert --file combined.pem"
          echo "  az keyvault secret set --vault-name ${{ steps.set_env.outputs.KEYVAULT }} --name ocis-tls-key --file privkey.pem"
          echo ""
          echo "‚ÑπÔ∏è This workflow only supports self-signed certificate generation"
          echo "For trusted certificates, please generate them manually and upload"
          exit 1

      - name: Upload OCIS certificate to Key Vault
        if: inputs.action == 'create' && inputs.certificate_type == 'self-signed'
        run: |
          # Upload certificate
          az keyvault certificate import \
            --vault-name ${{ steps.set_env.outputs.KEYVAULT }} \
            --name ocis-tls-cert \
            --file certs/ocis-tls-cert.pem
          
          # Upload private key as secret
          az keyvault secret set \
            --vault-name ${{ steps.set_env.outputs.KEYVAULT }} \
            --name ocis-tls-key \
            --file certs/ocis-tls-key.pem \
            --content-type "application/x-pem-file"
          
          echo "‚úÖ OCIS certificate uploaded to Key Vault"

      - name: Delete certificates from Key Vault
        if: inputs.action == 'delete'
        run: |
          # Delete OCIS certificates
          az keyvault certificate delete \
            --vault-name ${{ steps.set_env.outputs.KEYVAULT }} \
            --name ocis-tls-cert || true
          
          az keyvault secret delete \
            --vault-name ${{ steps.set_env.outputs.KEYVAULT }} \
            --name ocis-tls-key || true
          
          echo "‚úÖ OCIS certificates deleted from Key Vault"

      - name: Verify certificates in Key Vault
        if: inputs.action == 'create'
        run: |
          echo "üîç Verifying certificates in Key Vault..."
          
          # List certificates
          az keyvault certificate list \
            --vault-name ${{ steps.set_env.outputs.KEYVAULT }} \
            --query "[?starts_with(name, 'ocis-tls')].{Name:name, Enabled:attributes.enabled, Expires:attributes.expires}" \
            --output table
          
          # List secrets
          az keyvault secret list \
            --vault-name ${{ steps.set_env.outputs.KEYVAULT }} \
            --query "[?starts_with(name, 'ocis-tls')].{Name:name, Enabled:attributes.enabled}" \
            --output table

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -rf certs/
          echo "‚úÖ Temporary certificate files cleaned up"

      - name: Display summary
        run: |
          echo "## Certificate Management Summary"
          echo "- Environment: ${{ inputs.environment }}"
          echo "- Domain: ${{ steps.set_env.outputs.DOMAIN }}"
          echo "- Key Vault: ${{ steps.set_env.outputs.KEYVAULT }}"
          echo "- Action: ${{ inputs.action }}"
          echo "- Certificate Type: ${{ inputs.certificate_type }}"
          echo ""
          echo "‚úÖ Certificate management completed successfully!"
